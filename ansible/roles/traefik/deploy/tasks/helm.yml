---
- name: Install and configure Helm
  delegate_to: "{{ groups['rke2_servers'][0] }}"
  run_once: true
  block:
    - name: Install Helm
      ansible.builtin.get_url:
        url: "{{ traefik_helm_config.install_script_url }}"
        dest: /tmp/get-helm.sh
        mode: '0700'
      notify: cleanup temporary files

    - name: Execute Helm installer
      ansible.builtin.command:
        cmd: /tmp/get-helm.sh
        creates: "{{ traefik_helm_config.binary_path }}"

    - name: Add Traefik Helm repository
      kubernetes.core.helm_repository:
        name: "{{ traefik_helm_config.repo_name }}"
        repo_url: "{{ traefik_helm_config.repo_url }}"
