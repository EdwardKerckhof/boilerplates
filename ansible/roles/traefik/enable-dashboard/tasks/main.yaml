---
- name: Render and Apply Dashboard Configurations
  block:
    - name: Render Dashboard Secret
      ansible.builtin.template:
        src: dashboard-secret.yaml.j2
        dest: /tmp/dashboard-secret.yaml

    - name: Render Dashboard Middleware
      ansible.builtin.template:
        src: dashboard-middleware.yaml.j2
        dest: /tmp/dashboard-middleware.yaml

    - name: Render Dashboard Ingress
      ansible.builtin.template:
        src: dashboard-ingress.yaml.j2
        dest: /tmp/dashboard-ingress.yaml

    - name: Apply Kubernetes Configurations
      kubernetes.core.k8s:
        src: "{{ item }}"
        state: present
        kubeconfig: /etc/rancher/rke2/rke2.yaml
      loop:
        - /tmp/dashboard-secret.yaml
        - /tmp/dashboard-middleware.yaml
        - /tmp/dashboard-ingress.yaml

  delegate_to: "{{ groups['rke2_servers'][0] }}"
  run_once: true
